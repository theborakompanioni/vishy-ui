/*! { "name": "vissense-user-activity", "version": "0.3.0", "copyright": "(c) 2015 tbk" } */!function(a,b){"use strict";b(a,a.VisSense)}(this,function(a,b,c){"use strict";function d(b,c){j(b,function(b){b.call(c||a)})}function e(b){if(!(this instanceof e))return new e(b);this._config=i(b,{inactiveAfter:6e4,throttle:100,events:["resize","scroll","mousemove","mousewheel","keydown","mousedown","touchstart","touchmove"],active:l,inactive:l,update:l,referenceWindow:a}),this._listeners=[],this._cancelUpdate=l,this._state={changed:!0,active:!1,lastActivityTime:m(),started:!1},this._visibilityApi=f.createVisibilityApi(this._config.referenceWindow);var c=this;this._updateState=function(){var a=c._state.active,b=c.getTimeSinceLastActivity();c._visibilityApi.isHidden()||b>=c._config.inactiveAfter?c._state.active=!1:(c._state.active=!0,c._cancelUpdate(),c._cancelUpdate=h(function(){c._updateState()},c._config.inactiveAfter)),c._state.changed=a!==c._state.active,d(c._listeners,c)},this._onUserActivity=function(){c._state.lastActivityTime=m(),c._updateState()},this.onUpdate(this._config.update),this.onActive(this._config.active),this.onInactive(this._config.inactive)}var f=b.Utils,g=f.throttle,h=f.defer,i=f.defaults,j=f.forEach,k=f.isFunction,l=f.noop,m=f.now,n=b.VisMon.Strategy,o=function(a,b){var c=a.indexOf(b);return c>-1?(a.splice(c,1),!0):!1};e.prototype.start=function(){return this._state.started?this:(this._removeEventListeners=function(a,b,c){var d=c.referenceWindow,e=g(b,c.throttle),f=a.onVisibilityChange(e),h=c.events;return j(h,function(a){d.addEventListener(a,e,!1)}),function(){j(h,function(a){d.removeEventListener(a,e,!1)}),f()}}(this._visibilityApi,this._onUserActivity,this._config),this._state.started=!0,this._onUserActivity(),this)},e.prototype.stop=function(){return this._state.started?(this._removeEventListeners(),this._cancelUpdate(),this._state.started=!1,this):this},e.prototype.onUpdate=function(a){if(!k(a))return l;var b=a.bind(c,this);this._listeners.push(b);var d=this;return function(){return o(d._listeners,b)}},e.prototype.onChange=function(a){return this.onUpdate(function(b){b._state.changed&&a(b)})},e.prototype.onActive=function(a){return this.onChange(function(b){b._state.active&&a(b)})},e.prototype.onInactive=function(a){return this.onChange(function(b){b._state.active||a(b)})},e.prototype.isActive=function(){return!this._state.started||this._state.active},e.prototype.getTimeSinceLastActivity=function(){return m()-this._state.lastActivityTime},b.UserActivity=e,n.UserActivityStrategy=function(a){this._userActivity=new e(a);var b=this;this._visibilityHook=function(){return b._userActivity.isActive()}},n.UserActivityStrategy.prototype=Object.create(n.prototype),n.UserActivityStrategy.prototype.init=function(a){this._removeVisibilityHook=function(b){var c=a.visobj()._config.visibilityHooks;return c.push(b._visibilityHook),function(){o(c,b._visibilityHook)}}(this),this._removeOnChangeListener=this._userActivity.onChange(function(){a.update()})},n.UserActivityStrategy.prototype.start=function(){this._userActivity.start()},n.UserActivityStrategy.prototype.stop=function(){this._removeVisibilityHook(),this._removeOnChangeListener(),this._userActivity.stop()}});